{% extends "base.html" %}

{% block title %}{{ model_name }} - CivitAI Model{% endblock %}

{% block css %}
{# Do NOT call super() here to avoid inheriting linked CSS from base.html #}
<!-- Base CSS (Inlined) -->
<style>
{{ read_file('css/base.css') }}
</style>
<!-- Components CSS (Inlined) -->
<style>
{{ read_file('css/components.css') }}
</style>
<!-- model.css (Inlined) -->
<style>
{{ read_file('css/model.css') }}
</style>
{% endblock %}

{% block header %}{{ model_name }}{% endblock %}

{% block header_actions %}
{% endblock %}

{% block content %}
<!-- Hero Section with Featured Image -->
{% if images and images|length > 0 %}
<div class="model-hero">
    <div class="hero-image-container">
        {% if images[0].is_video %}
        <video src="{{ images[0].path }}" class="hero-media" muted loop autoplay playsinline></video>
        {% else %}
        <img src="{{ images[0].path }}" alt="{{ model_name }}" class="hero-media">
        {% endif %}
        <div class="hero-overlay"></div>
    </div>
    <div class="hero-content">
        <div class="hero-badges">
            <span class="hero-badge type-badge type-{{ model_type|lower|replace(' ', '-') }}">{{ model_type }}</span>
            {% if metadata.baseModel %}
            <span class="hero-badge base-badge">{{ metadata.baseModel }}</span>
            {% endif %}
        </div>
        <h1 class="hero-title">{{ model_name }}</h1>
        <div class="hero-stats">
            {% if stats and stats.downloadCount %}
            <div class="hero-stat">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                <span>{{ stats.downloadCount|default(0) }}</span>
            </div>
            {% endif %}
            {% if stats and stats.rating %}
            <div class="hero-stat">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                <span>{{ "%.1f"|format(stats.rating) }}</span>
            </div>
            {% endif %}
            {% if stats and stats.thumbsUpCount %}
            <div class="hero-stat">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>
                <span>{{ stats.thumbsUpCount }}</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Related Versions (other versions of the same model) -->
{% include "components/related_versions.html" %}

<!-- Model info component -->
{% include "components/model_info.html" %}

<div class="card">
    <h2 class="section-title">Model Details</h2>
    <div class="metadata-grid">
        {% if metadata.name %}
        <div class="metadata-item">
            <div class="metadata-label">Version Name:</div>
            <div class="metadata-value">{{ metadata.name }}</div>
        </div>
        {% endif %}

        {% if metadata.createdAt %}
        <div class="metadata-item">
            <div class="metadata-label">Created:</div>
            <div class="metadata-value">{{ metadata.createdAt|replace('T', ' ')|replace('Z', '')|replace('.000', '') }}</div>
        </div>
        {% endif %}

        {% if metadata.updatedAt %}
        <div class="metadata-item">
            <div class="metadata-label">Updated:</div>
            <div class="metadata-value">{{ metadata.updatedAt|replace('T', ' ')|replace('Z', '')|replace('.000', '') }}</div>
        </div>
        {% endif %}

        {% if metadata.status %}
        <div class="metadata-item">
            <div class="metadata-label">Status:</div>
            <div class="metadata-value">{{ metadata.status }}</div>
        </div>
        {% endif %}

        {% if metadata.baseModel %}
        <div class="metadata-item">
            <div class="metadata-label">Base Model:</div>
            <div class="metadata-value">{{ metadata.baseModel }}</div>
        </div>
        {% endif %}
    </div>

    {% if metadata.trainedWords %}
    <div class="trigger-words-container">
        <div class="trigger-words-header">
            <div class="trigger-words-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                <span>Trigger Words</span>
            </div>
            <button class="copy-all-triggers" title="Copy all trigger words">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                <span>Copy All</span>
            </button>
        </div>
        <div class="trigger-words-groups" data-all-words="{{ metadata.trainedWords|join(', ') }}">
            {% for wordGroup in metadata.trainedWords %}
            <div class="trigger-word-group" title="Click to copy" data-word="{{ wordGroup }}">
                <span class="trigger-text">{{ wordGroup }}</span>
                <span class="trigger-copy-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if description %}
    <div class="metadata-item" style="margin-top: 20px;">
        <div class="metadata-label">Description:</div>
        <div class="metadata-value">{{ description|safe }}</div>
    </div>
    {% endif %}
</div>

{% if images %}
<div class="card">
    <h2 class="section-title">Gallery</h2>
    <div class="gallery">
        {% for image in images %}
        <div class="gallery-item" data-index="{{ loop.index0 }}">
            {% if image.is_video %}
            <video src="{{ image.path }}" preload="metadata" class="preview-video" muted loop playsinline></video>
            <div class="video-indicator">VIDEO</div>
            <div class="video-play-overlay">
                <svg class="play-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                <svg class="pause-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
            </div>
            {% else %}
            <img src="{{ image.path }}" alt="Preview image" loading="lazy">
            {% endif %}
            <div class="image-metadata">
                {% if image.steps %}
                <span class="image-meta-item">Steps: {{ image.steps }}</span>
                {% endif %}
                {% if image.cfg_scale %}
                <span class="image-meta-item">CFG: {{ image.cfg_scale }}</span>
                {% endif %}
                {% if image.sampler %}
                <span class="image-meta-item">Sampler: {{ image.sampler }}</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Image viewer component -->
{% include "components/image_viewer.html" %}

<!-- Inline script for image viewer functionality -->
<script>
// Immediately executing function for image viewer functionality
(function() {
  const galleryItems = document.querySelectorAll('.gallery-item');
  if (galleryItems.length === 0) return;

  const imageViewer = document.getElementById('image-viewer');
  const viewerImage = document.getElementById('viewer-image');
  const viewerVideo = document.getElementById('viewer-video');
  const positivePrompt = document.getElementById('positive-prompt');
  const negativePrompt = document.getElementById('negative-prompt');
  const additionalInfo = document.getElementById('additional-info');
  const closeButton = document.getElementById('close-viewer');
  const prevButton = document.getElementById('prev-image');
  const nextButton = document.getElementById('next-image');
  const viewerCurrent = document.getElementById('viewer-current');
  const viewerTotal = document.getElementById('viewer-total');
  const thumbnailStrip = document.getElementById('thumbnail-strip');
  const copyAllMetadataBtn = document.getElementById('copy-all-metadata');
  const copyButtons = document.querySelectorAll('.copy-button');
  const imagesDataElem = document.getElementById('images-data');

  if (!imageViewer || !viewerImage || !viewerVideo || !imagesDataElem) return;

  let currentIndex = 0;

  // Toast notification helper
  function showToast(message) {
    let toast = document.querySelector('.copy-toast');
    if (!toast) {
      toast = document.createElement('div');
      toast.className = 'copy-toast';
      document.body.appendChild(toast);
    }
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
  }

  // Function to decode base64 encoded JSON data with Unicode support
  function decodeBase64Json(base64String) {
    try {
      const binary = atob(base64String);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      const jsonString = new TextDecoder('utf-8').decode(bytes);
      return JSON.parse(jsonString);
    } catch (e) {
      return [];
    }
  }

  // Parse image data
  let imageData;
  try {
    const encodedData = imagesDataElem.getAttribute('data-images');
    if (!encodedData) return;
    imageData = decodeBase64Json(encodedData);
    if (!Array.isArray(imageData) || imageData.length === 0) return;
  } catch (e) {
    return;
  }

  // Build thumbnail strip
  function buildThumbnails() {
    if (!thumbnailStrip) return;
    thumbnailStrip.innerHTML = '';
    galleryItems.forEach((item, index) => {
      const thumb = document.createElement('div');
      thumb.className = 'thumbnail-item' + (index === 0 ? ' active' : '');
      thumb.dataset.index = index;

      const media = item.querySelector('img') || item.querySelector('video');
      if (media) {
        if (media.tagName === 'VIDEO') {
          const video = document.createElement('video');
          video.src = media.src;
          video.muted = true;
          thumb.appendChild(video);
        } else {
          const img = document.createElement('img');
          img.src = media.src;
          img.alt = 'Thumbnail';
          thumb.appendChild(img);
        }
      }

      thumb.addEventListener('click', () => {
        currentIndex = index;
        openImageViewer(currentIndex);
      });

      thumbnailStrip.appendChild(thumb);
    });
  }

  // Update active thumbnail
  function updateActiveThumbnail(index) {
    if (!thumbnailStrip) return;
    thumbnailStrip.querySelectorAll('.thumbnail-item').forEach((item, i) => {
      item.classList.toggle('active', i === index);
    });
    // Scroll thumbnail into view
    const activeThumb = thumbnailStrip.querySelector('.thumbnail-item.active');
    if (activeThumb) {
      activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }
  }

  // Function to open image viewer
  function openImageViewer(index) {
    if (index < 0 || index >= imageData.length) return;

    currentIndex = index;
    const data = imageData[index];
    const galleryItem = galleryItems[index];
    const isVideo = data.is_video || false;

    // Pause any currently playing video first
    if (viewerVideo) {
      viewerVideo.pause();
    }

    if (isVideo) {
      const videoElement = galleryItem.querySelector('video');
      if (videoElement) {
        viewerVideo.src = videoElement.src;
        viewerVideo.style.display = 'block';
        viewerImage.style.display = 'none';
        // Autoplay the video
        viewerVideo.currentTime = 0;
        viewerVideo.play().catch(() => {});
      }
    } else {
      const imgElement = galleryItem.querySelector('img');
      if (imgElement) {
        viewerImage.src = imgElement.src;
        viewerImage.style.display = 'block';
        viewerVideo.style.display = 'none';
      }
    }

    // Update prompts
    if (positivePrompt) {
      positivePrompt.textContent = data.prompt || 'No positive prompt available';
    }
    if (negativePrompt) {
      negativePrompt.textContent = data.negative_prompt || 'No negative prompt available';
    }

    // Format additional info with grid layout
    if (additionalInfo) {
      let infoHTML = '';
      if (data.sampler) infoHTML += `<div><strong>Sampler</strong>${data.sampler}</div>`;
      if (data.cfg_scale) infoHTML += `<div><strong>CFG Scale</strong>${data.cfg_scale}</div>`;
      if (data.steps) infoHTML += `<div><strong>Steps</strong>${data.steps}</div>`;
      if (data.seed) infoHTML += `<div><strong>Seed</strong>${data.seed}</div>`;
      if (data.model) infoHTML += `<div><strong>Model</strong>${data.model}</div>`;
      additionalInfo.innerHTML = infoHTML || '<div>No additional information available</div>';
    }

    // Update counter
    if (viewerCurrent) viewerCurrent.textContent = index + 1;
    if (viewerTotal) viewerTotal.textContent = imageData.length;

    // Update thumbnails
    updateActiveThumbnail(index);

    imageViewer.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  // Close viewer
  function closeViewer() {
    imageViewer.classList.remove('active');
    imageViewer.classList.remove('fullscreen');
    document.body.style.overflow = '';
    if (viewerVideo) {
      viewerVideo.pause();
      viewerVideo.src = '';
    }
  }

  // Toggle fullscreen mode
  const fullscreenToggle = document.getElementById('fullscreen-toggle');

  function toggleFullscreen() {
    imageViewer.classList.toggle('fullscreen');
  }

  if (fullscreenToggle) {
    fullscreenToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleFullscreen();
    });
  }

  // Build thumbnails on load
  buildThumbnails();

  // Attach click events to gallery items
  galleryItems.forEach((item, index) => {
    item.addEventListener('click', () => {
      currentIndex = index;
      openImageViewer(currentIndex);
    });
  });

  // Close button
  if (closeButton) {
    closeButton.addEventListener('click', closeViewer);
  }

  // Click on backdrop to close
  const backdrop = imageViewer.querySelector('.viewer-backdrop');
  if (backdrop) {
    backdrop.addEventListener('click', closeViewer);
  }

  // Navigation
  if (prevButton) {
    prevButton.addEventListener('click', (e) => {
      e.stopPropagation();
      currentIndex = (currentIndex - 1 + imageData.length) % imageData.length;
      openImageViewer(currentIndex);
    });
  }

  if (nextButton) {
    nextButton.addEventListener('click', (e) => {
      e.stopPropagation();
      currentIndex = (currentIndex + 1) % imageData.length;
      openImageViewer(currentIndex);
    });
  }

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (!imageViewer.classList.contains('active')) return;

    if (e.key === 'Escape') {
      // Exit fullscreen first, then close viewer
      if (imageViewer.classList.contains('fullscreen')) {
        imageViewer.classList.remove('fullscreen');
      } else {
        closeViewer();
      }
    } else if (e.key === 'f' || e.key === 'F') {
      toggleFullscreen();
    } else if (e.key === 'ArrowLeft') {
      currentIndex = (currentIndex - 1 + imageData.length) % imageData.length;
      openImageViewer(currentIndex);
    } else if (e.key === 'ArrowRight') {
      currentIndex = (currentIndex + 1) % imageData.length;
      openImageViewer(currentIndex);
    }
  });

  // Copy to clipboard functionality with SVG icon support
  copyButtons.forEach(button => {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      const targetId = button.getAttribute('data-target');
      if (!targetId) return;

      const targetElement = document.getElementById(targetId);
      if (!targetElement) return;

      const text = targetElement.textContent;

      navigator.clipboard.writeText(text)
        .then(() => {
          button.classList.add('copied');
          showToast('Copied to clipboard!');
          setTimeout(() => button.classList.remove('copied'), 2000);
        })
        .catch(e => console.error('Error copying:', e));
    });
  });

  // Copy all metadata
  if (copyAllMetadataBtn) {
    copyAllMetadataBtn.addEventListener('click', () => {
      const data = imageData[currentIndex];
      if (!data) return;

      let text = '';
      if (data.prompt) text += `Positive Prompt:\n${data.prompt}\n\n`;
      if (data.negative_prompt) text += `Negative Prompt:\n${data.negative_prompt}\n\n`;
      if (data.sampler) text += `Sampler: ${data.sampler}\n`;
      if (data.cfg_scale) text += `CFG Scale: ${data.cfg_scale}\n`;
      if (data.steps) text += `Steps: ${data.steps}\n`;
      if (data.seed) text += `Seed: ${data.seed}\n`;
      if (data.model) text += `Model: ${data.model}\n`;

      navigator.clipboard.writeText(text.trim())
        .then(() => showToast('All metadata copied!'))
        .catch(e => console.error('Error copying:', e));
    });
  }

  // Video play/pause functionality (hover for desktop, tap for mobile)
  const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

  galleryItems.forEach(item => {
    const video = item.querySelector('video');
    if (!video) return;

    if (isTouchDevice) {
      // Touch devices: tap play button to toggle play/pause
      const playButton = item.querySelector('.video-play-overlay');
      if (playButton) {
        playButton.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();

          if (video.paused) {
            // Pause all other videos first
            document.querySelectorAll('.gallery-item.playing').forEach(other => {
              if (other !== item) {
                other.classList.remove('playing');
                const otherVideo = other.querySelector('video');
                if (otherVideo) {
                  otherVideo.pause();
                  otherVideo.currentTime = 0;
                }
              }
            });
            video.currentTime = 0;
            video.play().catch(() => {});
            item.classList.add('playing');
          } else {
            video.pause();
            item.classList.remove('playing');
          }
        });
      }
    } else {
      // Desktop: hover to play
      item.addEventListener('mouseenter', () => {
        video.currentTime = 0;
        video.play().catch(() => {});
        item.classList.add('playing');
      });

      item.addEventListener('mouseleave', () => {
        video.pause();
        video.currentTime = 0;
        item.classList.remove('playing');
      });
    }
  });
})();
</script>
{% endif %}

{% if metadata.files %}
<div class="card">
    <h2 class="section-title">Files</h2>
    {% for file in metadata.files %}
    <div class="file-item">
        <div class="file-header">
            <div class="file-name">{{ file.name }}</div>
            <div class="file-meta">
                <span class="file-size">{{ (file.sizeKB / 1024)|round(2) }} MB</span>
                {% if file.metadata %}
                    {% if file.metadata.fp %}
                    <span class="file-format">{{ file.metadata.fp }}</span>
                    {% endif %}
                    {% if file.metadata.size %}
                    <span class="file-size-info">{{ file.metadata.size }}</span>
                    {% endif %}
                    {% if file.metadata.format %}
                    <span class="file-format-info">{{ file.metadata.format }}</span>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        {% if file.local_path %}
        <div class="file-location-section">
            <div class="file-location-label">Local File Location:</div>
            <div class="file-location-container" data-path="{{ file.local_path }}">
                <div class="file-location-path">{{ file.local_path }}</div>
                <button class="copy-location-btn" title="Copy file path to clipboard">
                    <span class="copy-icon">ðŸ“‹</span>
                    <span class="copy-text">Copy Path</span>
                </button>
            </div>
        </div>
        {% endif %}

        {% if file.local_directory %}
        <div class="file-location-section">
            <div class="file-location-label">Directory:</div>
            <div class="file-location-container" data-path="{{ file.local_directory }}">
                <div class="file-location-path">{{ file.local_directory }}</div>
                <button class="copy-location-btn" title="Copy directory path to clipboard">
                    <span class="copy-icon">ðŸ“‹</span>
                    <span class="copy-text">Copy Directory</span>
                </button>
            </div>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block page_scripts %}
<script>
// Toast notification helper
function showToast(message) {
    let toast = document.querySelector('.copy-toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.className = 'copy-toast';
        document.body.appendChild(toast);
    }
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
}

// Copy to clipboard functionality for trigger words
document.querySelectorAll('.trigger-word-group').forEach(group => {
    group.addEventListener('click', () => {
        const word = group.getAttribute('data-word') || group.querySelector('.trigger-text').textContent.trim();

        navigator.clipboard.writeText(word)
            .then(() => {
                group.classList.add('copied');
                showToast(`Copied: ${word}`);
                setTimeout(() => group.classList.remove('copied'), 2000);
            })
            .catch(err => console.error('Failed to copy text:', err));
    });
});

// Copy all trigger words
const copyAllBtn = document.querySelector('.copy-all-triggers');
if (copyAllBtn) {
    copyAllBtn.addEventListener('click', () => {
        const wordsContainer = document.querySelector('.trigger-words-groups');
        const allWords = wordsContainer ? wordsContainer.getAttribute('data-all-words') : '';

        if (allWords) {
            navigator.clipboard.writeText(allWords)
                .then(() => showToast('All trigger words copied!'))
                .catch(err => console.error('Failed to copy:', err));
        }
    });
}

// Copy to clipboard functionality for file locations
document.querySelectorAll('.copy-location-btn').forEach(button => {
    button.addEventListener('click', () => {
        const container = button.closest('.file-location-container');
        const path = container.getAttribute('data-path');
        const textEl = button.querySelector('.copy-text');

        if (path) {
            navigator.clipboard.writeText(path)
                .then(() => {
                    const originalText = textEl.textContent;
                    textEl.textContent = 'Copied!';
                    button.style.background = 'linear-gradient(135deg, rgba(46, 204, 113, 0.25), rgba(46, 204, 113, 0.15))';
                    button.style.color = '#2ecc71';
                    showToast('Path copied!');

                    setTimeout(() => {
                        textEl.textContent = originalText;
                        button.style.background = '';
                        button.style.color = '';
                    }, 2000);
                })
                .catch(err => {
                    console.error('Failed to copy path:', err);
                    textEl.textContent = 'Failed';
                    button.style.color = '#e74c3c';
                    setTimeout(() => {
                        textEl.textContent = 'Copy Path';
                        button.style.color = '';
                    }, 2000);
                });
        }
    });
});
</script>
{% endblock %}
